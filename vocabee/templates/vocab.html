{% extends 'base.html' %}
{% set active_page = "vocab" %}

{% block container %}
    <title>N{{ level }} level words - Vocabee</title>
    <!--Stylesheets -->
    <link href="{{ url_for('static', filename='css/pages/vocab.css') }}" rel="stylesheet">

    <div class="container-fluid" id="vocab-table-container">
        <table class="table table-striped table-hover" id="vocab-table" style="width: 100%;"></table>
    </div>

    <script type="text/javascript">
        // Initialize vocabulary entries
        let vocab = {{ vocab | safe }};
        let entries = vocab.entries;

        $(document).ready(function () {
            $('#vocab-table').DataTable({
                data: entries,
                columns: [
                    {title: "ID"},
                    {title: "Kanji"},
                    {title: "Hiragana"},
                    {title: "English"},
                    {
                        title: "Examples",
                        orderable: false,
                        searchable: false,
                        render: function () {
                            return '<button ' +
                                'type="button" ' +
                                'class="btn btn-outline-primary" ' +
                                'id="example-select" ' +
                                'data-toggle="modal" ' +
                                'data-target="#vocab-modal">Show</button>\n'
                        }
                    }
                ],
                responsive: true
            });
        });

        $("#vocab-table").on('click', '#example-select', function (e) {
            // Get data from all rows, including hidden ones. Ref: https://stackoverflow.com/a/38515622
            e.preventDefault();
            let current_row = $(this).parents('tr');
            if (current_row.hasClass('child')) {
                current_row = current_row.prev();
            }
            let row_data = $('#vocab-table').DataTable().row(current_row).data();
            let vocab_id = row_data[0];

            // Retrieving the example data
            let endpoint = "/vocab/example/" + vocab_id;
            $.ajax({
                type: "GET",
                contentType: "vocabee/json; charset=utf-8",
                url: endpoint,
                success: function (result) {
                    result = $.parseJSON(result);

                    // Append content to modal body
                    let modal_content = document.getElementById("vocab-modal-body");
                    modal_content.innerHTML = '';
                    let example_count = result.length;
                    if (example_count > 0) {
                        for (let e of result) {
                            let paragraph = document.createElement("p");
                            paragraph.innerHTML = `${e[1]}<br>${e[2]}<br>`;
                            modal_content.appendChild(paragraph);
                        }
                    } else {
                        let paragraph = document.createElement("p");
                        paragraph.innerHTML = `Sorry, no examples for this entry...`;
                        modal_content.appendChild(paragraph);
                    }

                    // Set modal title
                    let modal_title = document.getElementById("modalLargeLabel");
                    let example_text = "examples";
                    if (example_count === 1) {
                        example_text = "example";
                    }

                    let hiragana = row_data[1].split(/<a[^>]*>([\s\S]*?)<\/a>/)[1];
                    if (typeof hiragana !== 'undefined') {
                        // Ref: https://stackoverflow.com/questions/7864723#7864740
                        modal_title.textContent = `Showing ${example_count} ${example_text} for ${hiragana}`;
                    } else {
                        let kanji = row_data[2].split(/<a[^>]*>([\s\S]*?)<\/a>/)[1];
                        modal_title.textContent = `Showing ${example_count} ${example_text} for ${kanji}`;
                    }
                }
            });
        })
    </script>

    <div class="modal fade modal-fullscreen" id="vocab-modal" tabindex="-1" role="dialog"
         aria-labelledby="modalLargeLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLargeLabel">Examples</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="vocab-modal-body">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}