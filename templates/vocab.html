{% extends 'base.html' %}
{% set active_page = "vocab" %}

{% block container %}

    <div class="container-fluid" id="vocab-table-container">
        <table class="table table-striped table-hover" id="vocab-table" style="width: 100%;"></table>
    </div>

    <script type="text/javascript">
        // Initialize vocabulary entries
        let vocab = {{ vocab | safe }};
        let entries = vocab.entries;

        $(document).ready(function () {
            $('#vocab-table').DataTable({
                data: entries,
                columns: [
                    {title: "Hiragana"},
                    {title: "Kanji"},
                    {title: "English"},
                    {
                        title: "Examples_raw",
                        visible: false,
                        searchable: false
                    },
                    {
                        title: "Examples",
                        orderable: false,
                        searchable: false,
                        render: function () {
                            return '<button ' +
                                'type="button" ' +
                                'class="btn btn-outline-primary" ' +
                                'id="example-select" ' +
                                'data-toggle="modal" ' +
                                'data-target="#vocab-modal">Show</button>\n'
                        }
                    }
                ],
                responsive: true
            });
        });

        $("#vocab-table").on('click', '#example-select', function (e) {
            // Get data from all rows, including hidden ones. Ref: https://stackoverflow.com/a/38515622
            e.preventDefault();
            let current_row = $(this).parents('tr');
            if (current_row.hasClass('child')) {
                current_row = current_row.prev();
            }
            let data = $('#vocab-table').DataTable().row(current_row).data();

            // Examples are contained inside multiple types of quotes, so we have to split them first
            let examples_raw = data[3];
            examples_raw = examples_raw.substring(1, examples_raw.length - 1);
            examples_raw = examples_raw.split(/'(.*?)'|"(.*?)"/);
            // Due to the way we split it, we also get undefined and commas in our array, so we filter those out
            let example_list = [];
            for (let e of examples_raw) {
                if (e !== undefined && e.startsWith("JP")) {
                    let language_split = e.split(/\\n /);
                    let jp_example = language_split[0];
                    let en_example = language_split[1].slice(0, 2) + ": " + language_split[1].slice(3);
                    example_list.push({
                        JP: jp_example,
                        EN: en_example
                    });
                }
            }

            // Append content to modal body
            let modal_content = document.getElementById("vocab-modal-body");
            modal_content.innerHTML = '';
            let example_count = example_list.length;
            if (example_list.length > 0) {
                for (let e of example_list) {
                    let paragraph = document.createElement("p");
                    paragraph.innerHTML = `${e.JP}<br>${e.EN}<br>`;
                    modal_content.appendChild(paragraph);
                }
            } else {
                let paragraph = document.createElement("p");
                paragraph.innerHTML = `Sorry, no examples for this entry...`;
                modal_content.appendChild(paragraph);
            }

            // Set modal title
            let modal_title = document.getElementById("modalLargeLabel");
            // Ref: https://stackoverflow.com/questions/7864723#7864740
            let hiragana = data[0].split(/<a[^>]*>([\s\S]*?)<\/a>/)[1];
            let example_text = "examples";
            if (example_count === 1) {
                example_text = "example";
            }
            modal_title.textContent = `Showing ${example_count} ${example_text} for ${hiragana}`;
        });
    </script>

    <div class="modal fade modal-fullscreen" id="vocab-modal" tabindex="-1" role="dialog"
         aria-labelledby="modalLargeLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalLargeLabel">Examples</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="vocab-modal-body">

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}